<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RefleMind</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Google: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="admin-navbar sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="brand-text fs-4">
                <i class="bi bi-shield-lock-fill"></i>
                RefleMind <span class="text-muted fw-normal fs-6 ms-1">| Admin Panel</span>
            </div>
            <button id="admin-logout" class="btn btn-logout">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </nav>

    <div class="container pb-5">

        <!-- Baris Statistik -->
        <div class="row mb-5">
            <div class="col-md-6 col-lg-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-value" id="total-users">...</div>
                            <div class="stat-label">Total Pengguna</div>
                        </div>
                        <i class="bi bi-people-fill fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
            <!-- bisa menambahkan kartu statistik lain di sini nanti -->
        </div>

        <!-- Tabel Pengguna -->
        <div class="table-card">
            <div class="table-header">
                <h5 class="table-title">Daftar Pengguna Terdaftar</h5>
                <span class="badge bg-light text-dark border">Real-time Data</span>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 5%;">#</th>
                            <th scope="col">Pengguna</th>
                            <th scope="col">Email</th>
                            <th scope="col">Role</th>
                            <th scope="col">Tanggal Gabung</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="spinner-border loading-spinner" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2">Memuat data pengguna...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Skrip Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js" type="module"></script>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const tableBody = document.getElementById('user-table-body');
        const totalCounter = document.getElementById('total-users');
        const logoutBtn = document.getElementById('admin-logout');

        // Helper untuk membuat inisial avatar
        function getInitials(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        // --- FUNGSI UTAMA: LOAD DATA ---
        async function loadUsers() {
            try {
                const q = query(collection(db, "users_list"), orderBy("joinedAt", "desc"));
                const querySnapshot = await getDocs(q);

                const total = querySnapshot.size;
                totalCounter.textContent = total;

                if (total === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">Belum ada data pengguna.</td></tr>`;
                    return;
                }

                let html = '';
                let no = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();

                    // Format Tanggal
                    let dateStr = '-';
                    if (data.joinedAt) {
                        const dateObj = new Date(data.joinedAt);
                        dateStr = dateObj.toLocaleDateString('id-ID', {
                            day: 'numeric', month: 'long', year: 'numeric'
                        });
                    }

                    // Badge Role
                    const roleHtml = data.role === 'admin'
                        ? '<span class="badge-admin">ADMIN</span>'
                        : '<span class="badge bg-light text-dark border">User</span>';

                    // Avatar & Nama
                    const username = data.username || 'Tanpa Nama';
                    const userHtml = `
                        <div class="user-info">
                            <div class="avatar-circle">${getInitials(username)}</div>
                            <span class="fw-bold text-dark">${username}</span>
                        </div>
                    `;

                    html += `
                        <tr>
                            <td>${no++}</td>
                            <td>${userHtml}</td>
                            <td class="text-muted">${data.email || '-'}</td>
                            <td>${roleHtml}</td>
                            <td class="text-muted small">${dateStr}</td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;

            } catch (error) {
                console.error("Error loading users:", error);
                let errorMsg = error.message;
                if (error.code === 'permission-denied') {
                    errorMsg = "Akses ditolak. Anda bukan Admin.";
                }
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-5">
                    <i class="bi bi-exclamation-circle fs-2 mb-2 d-block"></i>
                    ${errorMsg}
                </td></tr>`;
            }
        }

        // --- PENJAGA KEAMANAN HALAMAN ADMIN ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users_list", user.uid);
                try {
                    const userSnap = await getDoc(userDocRef);
                    if (userSnap.exists() && userSnap.data().role === 'admin') {
                        loadUsers();
                    } else {
                        alert("MAAF! Halaman ini khusus Admin.");
                        window.location.href = '../index.html';
                    }
                } catch (err) {
                    console.error("Gagal verifikasi admin:", err);
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-5">Gagal verifikasi hak akses.</td></tr>`;
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- LOGIKA LOGOUT ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (confirm("Logout dari Panel Admin?")) {
                    signOut(auth).catch((error) => {
                        console.error("Logout error:", error);
                        alert("Gagal logout.");
                    });
                }
            });
        }

    </script>
</body>

</html>